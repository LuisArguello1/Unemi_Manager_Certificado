{% extends 'layouts/base.html' %}
{% load widget_tweaks %}

{% block title %}Generar Certificados Masivos{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800">Generar Certificados Masivos</h1>
        <p class="text-gray-600 mt-2">Complete la informaci√≥n del evento y cargue el archivo Excel con los estudiantes</p>
    </div>

    <!-- Mensajes -->
    {% if messages %}
    <div class="mb-6">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} bg-{{ message.tags }}-100 border border-{{ message.tags }}-400 text-{{ message.tags }}-700 px-4 py-3 rounded mb-2">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Formulario -->
    <form method="post" enctype="multipart/form-data" class="bg-white shadow-md rounded-lg p-6">
        {% csrf_token %}

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Columna Izquierda: Informaci√≥n del Evento -->
            <div>
                <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">
                    üìã Informaci√≥n del Evento
                </h2>

                <div class="space-y-4">
                    <!-- Direcci√≥n/Gesti√≥n -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            {{ evento_form.direccion_gestion.label }}
                        </label>
                        {{ evento_form.direccion_gestion }}
                        {% if evento_form.direccion_gestion.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ evento_form.direccion_gestion.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <!-- Variante de Plantilla (se muestra din√°micamente) -->
                    <div id="variante-container" style="display:none;">
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            {{ evento_form.variante_plantilla.label }}
                        </label>
                        <select id="id_variante_plantilla" name="variante_plantilla" class="w-full px-3 py-1.5 text-xs border border-gray-300 rounded-sm focus:outline-none focus:ring-1 focus:ring-indigo-500">
                            <option value="">-- Usar plantilla base --</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">{{ evento_form.variante_plantilla.help_text }}</p>
                    </div>

                    <!-- Modalidad -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            {{ evento_form.modalidad.label }}
                        </label>
                        {{ evento_form.modalidad }}
                    </div>

                    <!-- Nombre del Evento -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            {{ evento_form.nombre_evento.label }}
                        </label>
                        {{ evento_form.nombre_evento }}
                    </div>

                    <!-- Tipo -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            {{ evento_form.tipo.label }}
                        </label>
                        {{ evento_form.tipo }}
                    </div>

                    <!-- Tipo Evento -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            {{ evento_form.tipo_evento.label }}
                        </label>
                        {{ evento_form.tipo_evento }}
                    </div>

                    <!-- Duraci√≥n -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            {{ evento_form.duracion_horas.label }}
                        </label>
                        {{ evento_form.duracion_horas }}
                    </div>

                    <!-- Fechas -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                {{ evento_form.fecha_inicio.label }}
                            </label>
                            {{ evento_form.fecha_inicio }}
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                {{ evento_form.fecha_fin.label }}
                            </label>
                            {{ evento_form.fecha_fin }}
                        </div>
                    </div>

                    <!-- Fecha Emisi√≥n -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            {{ evento_form.fecha_emision.label }}
                        </label>
                        {{ evento_form.fecha_emision }}
                    </div>

                    <!-- Objetivo -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            {{ evento_form.objetivo_programa.label }}
                        </label>
                        {{ evento_form.objetivo_programa }}
                    </div>

                    <!-- Contenido -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            {{ evento_form.contenido_programa.label }}
                        </label>
                        {{ evento_form.contenido_programa }}
                    </div>
                </div>
            </div>

            <!-- Columna Derecha: Carga de Estudiantes -->
            <div>
                <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">
                    üìÅ Cargar Estudiantes (Excel)
                </h2>

                <div class="space-y-4">
                    <!-- File Upload -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            {{ excel_form.archivo_excel.label }}
                        </label>
                        {{ excel_form.archivo_excel }}
                        <p class="text-xs text-gray-500 mt-1">{{ excel_form.archivo_excel.help_text }}</p>
                    </div>

                    <!-- Instrucciones -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mt-4">
                        <h3 class="font-semibold text-blue-800 mb-2">üìä Formato Excel Requerido:</h3>
                        <ul class="text-sm text-blue-700 space-y-1">
                            <li>‚úì Columna 1: <strong>NOMBRES COMPLETOS</strong></li>
                            <li>‚úì Columna 2: <strong>CORREO ELECTRONICO</strong></li>
                            <li>‚úì Formato: .xlsx o .xls</li>
                            <li>‚úì Tama√±o m√°ximo: 5MB</li>
                        </ul>
                    </div>

                    <!-- Info adicional -->
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mt-4">
                        <h3 class="font-semibold text-gray-800 mb-2">‚ÑπÔ∏è Proceso de Generaci√≥n:</h3>
                        <ol class="text-sm text-gray-600 space-y-1 list-decimal list-inside">
                            <li>Sistema selecciona plantilla seg√∫n direcci√≥n</li>
                            <li>Genera certificados DOCX con variables reemplazadas</li>
                            <li>Convierte a PDF</li>
                            <li>Env√≠a por correo electr√≥nico a cada estudiante</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bot√≥n de Env√≠o -->
        <div class="mt-8 flex justify-end">
            <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-8 py-3 rounded-md transition-colors duration-200">
                üöÄ Generar Certificados
            </button>
        </div>
    </form>
</div>

<!-- JavaScript para cargar variantes v√≠a AJAX -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const direccionSelect = document.getElementById('id_direccion_gestion');
    const varianteContainer = document.getElementById('variante-container');
    const varianteSelect = document.getElementById('id_variante_plantilla');

    if (direccionSelect) {
        direccionSelect.addEventListener('change', function() {
            const direccionId = this.value;
            
            if (!direccionId) {
                varianteContainer.style.display = 'none';
                return;
            }

            // Llamada AJAX para obtener variantes
            fetch(`/certificados/api/variantes/${direccionId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Limpiar select
                        varianteSelect.innerHTML = '<option value="">-- Usar plantilla base --</option>';
                        
                        // Agregar variantes
                        data.variantes.forEach(variante => {
                            const option = document.createElement('option');
                            option.value = variante.id;
                            option.textContent = variante.nombre;
                            if (variante.descripcion) {
                                option.title = variante.descripcion;
                            }
                            varianteSelect.appendChild(option);
                        });
                        
                        // Mostrar container si hay variantes
                        if (data.variantes.length > 0) {
                            varianteContainer.style.display = 'block';
                        } else {
                            varianteContainer.style.display = 'none';
                        }
                    }
                })
                .catch(error => {
                    console.error('Error al cargar variantes:', error);
                });
        });
    }
});
</script>
{% endblock %}
