{% extends 'layouts/base.html' %}
{% load static %}

{% block title %}Editor de Certificados - {{ object.nombre }}{% endblock %}

{% block extra_css %}
   <link rel="stylesheet" href="{% static 'css/editor_certificado.css' %}">
{% endblock %}

{% block content %}
<div class="ppt-editor">
    
    <!-- BARRA SUPERIOR -->
    <div class="toolbar">
        <div class="toolbar-left">
            <div class="toolbar-title">
                <i class="fas fa-certificate"></i>
                Editor de Certificados
            </div>
            
            <div class="dropdown">
                <button class="tool-btn" onclick="toggleDropdown(event)">
                    <i class="fas fa-plus"></i> Añadir <i class="fas fa-caret-down" style="margin-left:4px"></i>
                </button>
                <div id="dropdown" class="dropdown-content">
                    <div class="dropdown-item" onclick="addBlock('textbox'); closeDropdown()">
                        <i class="fas fa-font"></i> Cuadro de Texto
                    </div>
                    <div class="dropdown-item" onclick="addBlock('image'); closeDropdown()">
                        <i class="fas fa-image"></i> Imagen
                    </div>
                    <div class="dropdown-item" onclick="addBlock('textbox'); closeDropdown()">
                        <i class="fas fa-font"></i> Cuadro de Texto
                    </div>
                    <div class="dropdown-item" onclick="addBlock('title'); closeDropdown()">
                        <i class="fas fa-heading"></i> Título
                    </div>
                    <div class="dropdown-item" onclick="addBlock('subtitle'); closeDropdown()">
                        <i class="fas fa-align-center"></i> Subtítulo
                    </div>
                    <div class="dropdown-item" onclick="addBlock('student'); closeDropdown()">
                        <i class="fas fa-user-graduate"></i> Nombre Estudiante
                    </div>
                    <div class="dropdown-item" onclick="addBlock('course'); closeDropdown()">
                        <i class="fas fa-book"></i> Nombre Curso
                    </div>
                    <div class="dropdown-item" onclick="addBlock('dates'); closeDropdown()">
                        <i class="fas fa-calendar"></i> Fechas
                    </div>
                    <div class="dropdown-item" onclick="addBlock('responsible'); closeDropdown()">
                        <i class="fas fa-user-tie"></i> Responsable
                    </div>
                    <div class="dropdown-item" onclick="addBlock('signature'); closeDropdown()">
                        <i class="fas fa-pen-fancy"></i> Línea de Firma
                    </div>
                    <div class="dropdown-item" onclick="addBlock('footer'); closeDropdown()">
                        <i class="fas fa-quote-right"></i> Pie de Página
                    </div>
                    <div class="dropdown-item" onclick="addBlock('cedula'); closeDropdown()">
                        <i class="fas fa-id-card"></i> Cédula
                    </div>
                    <div class="dropdown-item" onclick="addBlock('issue_date'); closeDropdown()">
                        <i class="far fa-calendar-check"></i> Fecha de Emisión
                    </div>
                </div>
            </div>
        </div>

        <div class="toolbar-center">
            <div class="zoom-group">
                <button onclick="setZoom(0.5, this)" class="zoom-btn">50%</button>
                <button class="zoom-btn active" onclick="setZoom(0.75)">75%</button>
                <button class="zoom-btn" onclick="setZoom(1)">100%</button>
                <button class="zoom-btn" onclick="setZoom(1.5)">150%</button>
                <button class="zoom-btn" onclick="fitToWindow()" title="Ajustar">
                    <i class="fas fa-expand"></i>
                </button>
            </div>
        </div>

        <div class="toolbar-right">
            <button class="tool-btn primary" onclick="saveConfig()">
                <i class="fas fa-save"></i> GUARDAR
            </button>
            <a href="{% url 'curso:estudiantes' object.pk %}" class="tool-btn">
                <i class="fas fa-times"></i> Cancelar
            </a>
        </div>
    </div>

    <!-- ÁREA PRINCIPAL -->
    <div class="main-area">
        
        <!-- WORKSPACE -->
        <div class="workspace" id="workspace">
            <div class="canvas-container" id="canvasContainer">
                <div id="certificate-area">
                    <img id="certificate-bg" src="{{ object.plantilla_certificado.archivo.url }}" alt="Certificado Base">
                    <div id="grid-overlay" class="grid-overlay"></div>
                </div>
            </div>
        </div>

        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('props')">Propiedades</button>
                <button class="tab" onclick="switchTab('elements')">Elementos</button>
            </div>

            <div class="tab-content">
                <!-- TAB PROPIEDADES -->
                <div id="tab-props" class="tab-pane active">
                    <div id="no-selection" class="empty-state">
                        <i class="fas fa-mouse-pointer" style="font-size:32px;opacity:0.3;margin-bottom:12px"></i>
                        <p style="font-size:12px">Selecciona un elemento para editar</p>
                    </div>

                    <div id="props-panel" style="display:none">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:2px solid #eee">
                            <span id="block-type" style="font-size:10px;font-weight:700;background:#e3f2fd;color:#1976d2;padding:4px 8px;border-radius:3px;text-transform:uppercase"></span>
                            <button onclick="deleteBlock()" style="border:none;background:none;color:#ef4444;cursor:pointer">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>

                        <div class="prop-group">
                            <label class="prop-label">Texto</label>
                            <textarea id="text" class="prop-input" rows="4"></textarea>
                        </div>

                        <div class="prop-group" id="imageGroup" style="display:none">
                            <label class="prop-label">Imagen</label>
                            
                            <div style="display:flex;gap:8px;margin-bottom:8px">
                                <button onclick="document.getElementById('imgUpload').click()" class="btn-upload-premium" style="width:100%;justify-content:center">
                                    <i class="fas fa-magic mr-2"></i> Seleccionar Imagen
                                </button>
                                <input type="file" id="imgUpload" accept="image/*" style="display:none" onchange="uploadImage(this)">
                            </div>
                            <p style="font-size:9px;color:#888;margin-top:4px;text-align:center">Selecciona una imagen de tu dispositivo.</p>
                        </div>

                        <div class="prop-group" id="nameFormatGroup" style="display:none">
                            <label class="prop-label">Formato de Nombre</label>
                            <select id="nameFormat" class="prop-select">
                                <option value="full">Completo (Juan Carlos Perez)</option>
                                <option value="first_last">Primer Nombre + Apellido (Juan Perez)</option>
                                <option value="f_last">Inicial + Apellido (J. Perez)</option>
                                <option value="first_l">Nombre + Inicial (Juan P.)</option>
                            </select>
                        </div>

                        <div class="prop-group">
                            <label class="prop-label">Fuente</label>
                            <select id="fontFamily" class="prop-select">
                                <option value="Arial, sans-serif">Arial</option>
                                <option value="Times New Roman, serif">Times New Roman</option>
                                <option value="Georgia, serif">Georgia</option>
                                <option value="Courier New, monospace">Courier New</option>
                                <option value="Verdana, sans-serif">Verdana</option>
                                <option value="Ubuntu, sans-serif">Ubuntu</option>
                                <option value="Noto Sans, sans-serif">Noto Sans</option>
                                <option value="Noto Serif, serif">Noto Serif</option>
                                <option value="Liberation Sans, sans-serif">Liberation Sans</option>
                                <option value="Liberation Serif, serif">Liberation Serif</option>
                            </select>
                        </div>

                        <div class="prop-group">
                            <label class="prop-label">Tamaño</label>
                            <div style="display:flex;gap:8px;align-items:center">
                                <input type="range" id="fontSize" class="prop-slider" min="8" max="150" style="flex:1">
                                <span id="fontSizeVal" style="font-size:11px;font-weight:600;width:40px;text-align:right">24px</span>
                            </div>
                        </div>

                        <div class="prop-group">
                            <label class="prop-label">Color</label>
                            <input type="color" id="color" class="prop-input" style="height:40px">
                        </div>

                        <div class="prop-group">
                            <label class="prop-label">Alineación</label>
                            <div class="btn-group">
                                <button id="btnLeft" class="btn-prop" onclick="setAlign('left')" title="Izquierda">
                                    <i class="fas fa-align-left"></i>
                                </button>
                                <button id="btnCenter" class="btn-prop active" onclick="setAlign('center')" title="Centro">
                                    <i class="fas fa-align-center"></i>
                                </button>
                                <button id="btnRight" class="btn-prop" onclick="setAlign('right')" title="Derecha">
                                    <i class="fas fa-align-right"></i>
                                </button>
                                <button id="btnJustify" onclick="setAlign('justify')" class="btn-prop" title="Justificar">
                                    <i class="fas fa-align-justify"></i>
                                </button>
                            </div>
                        </div>

                        <div class="prop-group">
                            <label class="prop-label">Estilo</label>
                            <div class="btn-group">
                                <button id="btnBold" class="btn-prop" onclick="toggleBold()"><i class="fas fa-bold"></i></button>
                                <button id="btnItalic" class="btn-prop" onclick="toggleItalic()"><i class="fas fa-italic"></i></button>
                                <button id="btnUnderline" class="btn-prop" onclick="toggleUnderline()"><i class="fas fa-underline"></i></button>
                            </div>
                        </div>

                        <div class="prop-group">
                            <label class="prop-label">Espaciado de Letras</label>
                            <div style="display:flex;gap:8px;align-items:center">
                                <input type="range" id="letterSpacing" class="prop-slider" min="-2" max="10" step="0.5" value="0" style="flex:1">
                                <span id="letterSpacingVal" style="font-size:11px;font-weight:600;width:40px;text-align:right">0px</span>
                            </div>
                        </div>

                        <div class="prop-group">
                            <label class="prop-label">Opacidad</label>
                            <div style="display:flex;gap:8px;align-items:center">
                                <input type="range" id="opacity" class="prop-slider" min="0" max="1" step="0.1" value="1" style="flex:1">
                                <span id="opacityVal" style="font-size:11px;font-weight:600;width:40px;text-align:right">100%</span>
                            </div>
                        </div>



                        <div class="prop-group">
                            <label class="prop-label">Rotación</label>
                            <div style="display:flex;gap:8px;align-items:center">
                                <input type="range" id="rotation" class="prop-slider" min="0" max="360" step="1" value="0" style="flex:1">
                                <span id="rotationVal" style="font-size:11px;font-weight:600;width:40px;text-align:right">0°</span>
                            </div>
                        </div>

                        <div class="prop-group" id="dimensionsGroup">
                            <label class="prop-label">Dimensiones (%)</label>
                            <div style="display:flex;gap:8px;align-items:center">
                                <div style="flex:1">
                                    <label style="font-size:9px;color:#666">Ancho</label>
                                    <input type="number" id="widthPct" class="prop-input" min="1" max="100" style="padding:4px">
                                </div>
                                <div style="flex:1">
                                    <label style="font-size:9px;color:#666">Alto</label>
                                    <input type="number" id="heightPct" class="prop-input" min="1" max="100" style="padding:4px" placeholder="Auto">
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- TAB ELEMENTOS -->
                <div id="tab-elements" class="tab-pane">
                    <div id="blocks-list"></div>
                    <div id="empty-elements" class="empty-state" style="display:none">
                        <i class="fas fa-layer-group" style="font-size:32px;opacity:0.3;margin-bottom:12px"></i>
                        <p style="font-size:12px">No hay elementos</p>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- FORM OCULTO -->
    <form id="saveForm" method="post" action="{% url 'curso:config' object.pk %}" style="display:none">
        {% csrf_token %}
        <input type="hidden" name="plantilla_certificado" value="{{ object.plantilla_certificado.pk }}">
        <input type="hidden" id="config" name="configuracion_certificado">
    </form>
    
    <!-- Configuración guardada para el editor -->
    <!-- Configuración guardada para el editor (Script seguro para JSON) -->
    {{ object.configuracion_certificado_json|json_script:"config-data" }}
    <input type="hidden" id="savedConfig" value=""> <!-- Deprecated, kept for safety if needed by other scripts momentarily -->

</div>
{% endblock %}

{% block extra_js %}
<script>
    const UPLOAD_URL = "/curso/upload-image/";
</script>
<script src="{% static 'js/editor_certificado.js' %}"></script>
{% endblock %}