{% extends 'layouts/base.html' %}
{% load static %}

{% block title %}Nueva Campaña{% endblock %}

{% block extra_css %}
<!-- Quill CSS -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<style>
    .ql-container {
        height: 300px; /* Altura del editor */
        font-family: inherit;
        font-size: 14px;
    }
    .ql-toolbar.ql-snow {
        border-color: #d1d5db;
        border-top-left-radius: 0.375rem;
        border-top-right-radius: 0.375rem;
    }
    .ql-container.ql-snow {
        border-color: #d1d5db;
        border-bottom-left-radius: 0.375rem;
        border-bottom-right-radius: 0.375rem;
    }
    
    /* Mostrar tooltips nativos del navegador mejorando la UX */
    .ql-formats button[title]:hover::after {
        content: attr(title);
        position: absolute;
        top: -25px;
        left: 50%;
        transform: translateX(-50%);
        background: #333;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        white-space: nowrap;
        z-index: 10;
        pointer-events: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <!-- Header -->
    <div class="mb-8 flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-800 tracking-tight">Nueva Campaña de Correo</h1>
            <p class="text-sm text-gray-500 mt-1">Configure los detalles del envío masivo de certificados.</p>
        </div>
        <div class="hidden md:block">
            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                <i class="fas fa-envelopes-bulk mr-1.5"></i> Módulo de Correo
            </span>
        </div>
    </div>

    <!-- Formulario Principal -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
        
        <!-- Toolbar Superior -->
        <div class="bg-gray-50 border-b border-gray-200 px-6 py-3 flex justify-between items-center">
            <h2 class="text-sm font-semibold text-gray-700 flex items-center">
                <i class="fas fa-pen-to-square mr-2 text-gray-400"></i>
                Datos de la Campaña
            </h2>
        </div>

        <form method="post" class="p-6 md:p-8 space-y-6">
            {% csrf_token %}

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Nombre de la Campaña -->
                <div>
                    <label for="{{ form.name.id_for_label }}" class="block text-xs font-semibold text-gray-600 uppercase tracking-wider mb-1.5">
                        {{ form.name.label }} <span class="text-red-500">*</span>
                    </label>
                    {{ form.name }}
                    {% if form.name.errors %}
                        <p class="mt-1 text-xs text-red-600 flex items-center">
                            <i class="fas fa-circle-exclamation mr-1"></i> {{ form.name.errors.0 }}
                        </p>
                    {% endif %}
                </div>

                <!-- Selección de Curso (Visual) -->
                <div>
                    <label class="block text-xs font-semibold text-gray-600 uppercase tracking-wider mb-1.5">
                        Curso Destino <span class="text-red-500">*</span>
                    </label>
                    
                    <!-- Select original oculto para compatibilidad con Django Form -->
                    <div class="hidden">
                        {{ form.course }}
                    </div>
                    
                    <!-- Componente Visual de Selección -->
                    <div id="course-selector-container" class="relative group cursor-pointer border-2 border-dashed border-gray-300 rounded-xl p-4 hover:border-indigo-400 transition-all duration-300 bg-gray-50">
                        
                        <!-- Estado: Sin Selección -->
                        <div id="no-course-state" class="flex flex-col items-center justify-center py-6 {% if form.course.value %}hidden{% endif %}">
                            <div class="w-12 h-12 bg-blue-50 text-blue-500 rounded-full flex items-center justify-center mb-2">
                                <i class="fas fa-graduation-cap text-xl"></i>
                            </div>
                            <p class="text-sm font-medium text-gray-600">Ningún curso seleccionado</p>
                            <button type="button" onclick="openModal('courseModal')" class="mt-3 px-4 py-1.5 bg-blue-600 text-white text-xs font-bold rounded shadow-sm hover:bg-blue-700 transition-colors">
                                SELECCIONAR CURSO
                            </button>
                        </div>

                        <!-- Estado: Curso Seleccionado -->
                        <div id="course-selected-state" class="{% if not form.course.value %}hidden{% endif %}">
                            <div class="flex items-start justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-lg bg-indigo-100 flex items-center justify-center text-indigo-600 font-bold text-lg">
                                        <i class="fas fa-check"></i>
                                    </div>
                                    <div>
                                        <h3 id="selected-course-name" class="font-bold text-gray-800 text-sm">Nombre del Curso</h3>
                                        <p class="text-xs text-gray-500"><span id="selected-course-count">0</span> estudiantes inscritos</p>
                                    </div>
                                </div>
                                <button type="button" onclick="openModal('courseModal')" class="text-xs text-blue-600 font-medium hover:text-blue-800 underline">
                                    Cambiar
                                </button>
                            </div>
                            
                            <!-- Preview del PDF (Si existe) -->
                            <div id="pdf-preview-link" class="mt-4 p-3 bg-red-50 border border-red-100 rounded-lg flex items-center justify-between hidden">
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-file-pdf text-red-500"></i>
                                    <span class="text-xs font-medium text-red-800">Muestra de Certificado Generado</span>
                                </div>
                                <a href="#" target="_blank" id="btn-view-pdf" class="text-xs bg-white border border-red-200 text-red-700 px-2 py-1 rounded hover:bg-red-50 transition-colors">
                                    <i class="fas fa-eye mr-1"></i> Ver PDF
                                </a>
                            </div>
                        </div>
                    </div>
                    {% if form.course.errors %}
                        <p class="mt-1 text-xs text-red-600 flex items-center">
                            <i class="fas fa-circle-exclamation mr-1"></i> {{ form.course.errors.0 }}
                        </p>
                    {% endif %}
                    <p class="mt-1 text-xs text-gray-400">Solo se permiten cursos con estudiantes y certificados generados.</p>
                </div>

                <!-- MODAL DE SELECCIÓN DE CURSO -->
                <div id="courseModal" class="fixed inset-0 z-[100] hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
                    <div class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm transition-opacity" onclick="closeModal('courseModal')"></div>
                    <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
                        <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                            <div class="relative transform overflow-hidden rounded-xl bg-white text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-2xl border border-gray-100">
                                
                                <!-- Header -->
                                <div class="bg-white px-4 py-3 border-b border-gray-100 flex justify-between items-center sticky top-0 z-10">
                                    <h3 class="text-sm font-bold text-gray-800 uppercase tracking-wide">Seleccionar Curso</h3>
                                    <button type="button" onclick="closeModal('courseModal')" class="text-gray-400 hover:text-gray-600">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>

                                <!-- Lista de Cursos -->
                                <div class="max-h-[60vh] overflow-y-auto p-4 bg-gray-50 space-y-3">
                                    {% for curso in available_courses %}
                                    <div class="relative bg-white border rounded-lg p-4 transition-all duration-200 
                                                {% if curso.tiene_certificados %}hover:border-blue-500 hover:shadow-md cursor-pointer{% else %}opacity-60 border-gray-100 cursor-not-allowed grayscale{% endif %}"
                                         {% if curso.tiene_certificados %}onclick="selectCourse('{{ curso.id }}', '{{ curso.nombre }}', '{{ curso.estudiantes_count }}', '{{ curso.preview_url|default:'' }}')"{% endif %}>
                                        
                                        <div class="flex justify-between items-start">
                                            <div class="flex items-start gap-3">
                                                <div class="mt-1 w-8 h-8 rounded bg-blue-50 text-blue-600 flex items-center justify-center font-bold text-xs">
                                                    {{ curso.nombre|slice:":1" }}
                                                </div>
                                                <div>
                                                    <h4 class="text-sm font-bold text-gray-800">{{ curso.nombre }}</h4>
                                                    <p class="text-xs text-gray-500 mt-0.5">{{ curso.estudiantes_count }} Estudiantes registrados</p>
                                                    
                                                    {% if not curso.tiene_certificados %}
                                                    <span class="inline-flex items-center mt-2 px-2 py-0.5 rounded text-[10px] font-medium bg-red-100 text-red-700">
                                                        <i class="fas fa-ban mr-1"></i> Sin certificados generados
                                                    </span>
                                                    {% else %}
                                                    <span class="inline-flex items-center mt-2 px-2 py-0.5 rounded text-[10px] font-medium bg-green-100 text-green-700">
                                                        <i class="fas fa-check-circle mr-1"></i> Listo para enviar
                                                    </span>
                                                    {% endif %}
                                                </div>
                                            </div>

                                            {% if curso.tiene_certificados and curso.preview_url %}
                                            <div class="flex flex-col items-end gap-2" onclick="event.stopPropagation()">
                                                <a href="{{ curso.preview_url }}" target="_blank" class="text-[10px] font-bold text-gray-500 hover:text-blue-600 border border-gray-200 px-2 py-1 rounded bg-gray-50 hover:bg-white transition-colors">
                                                    <i class="far fa-file-pdf mr-1"></i> Ver Muestra
                                                </a>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% empty %}
                                    <div class="text-center py-8 text-gray-500 text-sm">No hay cursos disponibles.</div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Asunto -->
            <div>
                <label for="{{ form.subject.id_for_label }}" class="block text-xs font-semibold text-gray-600 uppercase tracking-wider mb-1.5">
                    {{ form.subject.label }} <span class="text-red-500">*</span>
                </label>
                {{ form.subject }}
                {% if form.subject.errors %}
                    <p class="mt-1 text-xs text-red-600 flex items-center">
                        <i class="fas fa-circle-exclamation mr-1"></i> {{ form.subject.errors.0 }}
                    </p>
                {% endif %}
            </div>

            <!-- Editor de Texto Enriquecido -->
            <div>
                <label for="{{ form.message.id_for_label }}" class="block text-xs font-semibold text-gray-600 uppercase tracking-wider mb-1.5">
                    {{ form.message.label }}
                </label>
                
                <!-- Contenedor del Editor -->
                <div id="editor-container" class="bg-white" data-input-id="{{ form.message.id_for_label }}"></div>
                
                <!-- Input oculto para guardar el contenido -->
                {{ form.message }} <!-- Este se ocultará vía CSS o JS, idealmente form.message debería ser hidden -->
                
                {% if form.message.errors %}
                    <p class="mt-1 text-xs text-red-600 flex items-center">
                        <i class="fas fa-circle-exclamation mr-1"></i> {{ form.message.errors.0 }}
                    </p>
                {% endif %}
                <p class="mt-1 text-xs text-gray-400">Puede usar formato enriquecido. Las imágenes copiadas se guardarán directamente.</p>
            </div>

            <!-- Botones de Acción -->
            <div class="pt-6 border-t border-gray-100 flex items-center justify-end space-x-3">
                <a href="{% url 'correo:list' %}" 
                   class="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded text-sm font-medium hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
                    Cancelar
                </a>
                <button type="submit" 
                        class="px-4 py-2 bg-indigo-600 border border-transparent text-white rounded text-sm font-medium hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 shadow-sm transition-colors flex items-center">
                    <span>Siguiente: Previsualizar</span>
                    <i class="fas fa-chevron-right ml-2 text-xs"></i>
                </button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- Quill JS -->
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<!-- Page Specific JS -->
<script src="{% static 'js/pages/campaign-create.js' %}"></script>
{% endblock %}
